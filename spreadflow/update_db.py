import time
from sqlalchemy import text
from db_session import engine
from models import Base
# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –º–æ–¥–µ–ª–∏, —á—Ç–æ–±—ã SQLAlchemy –∑–Ω–∞–ª–∞ –æ –Ω–∏—Ö –ø—Ä–∏ create_all
from models import User, Plan, Subscription, Invite, ActivityLog, AdminNote
from logger import log

def fix_database_schema():
    """
    –û–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ë–î –¥–æ –∞–∫—Ç—É–∞–ª—å–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è models.py.
    1. –î–æ–±–∞–≤–ª—è–µ—Ç –Ω–æ–≤—ã–µ –∫–æ–ª–æ–Ω–∫–∏ –≤ users (–±–µ–∑ —É–¥–∞–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö).
    2. –ü–µ—Ä–µ—Å–æ–∑–¥–∞–µ—Ç —Ç–∞–±–ª–∏—Ü—ã —Ç–∞—Ä–∏—Ñ–æ–≤ –∏ –ø–æ–¥–ø–∏—Å–æ–∫ (–¥–ª—è —á–∏—Å—Ç–æ—Ç—ã –Ω–∞—Å—Ç—Ä–æ–µ–∫).
    """
    print("üõ†Ô∏è  –ù–ê–ß–ò–ù–ê–ï–ú –û–ë–ù–û–í–õ–ï–ù–ò–ï –°–•–ï–ú–´ –ë–ê–ó–´ –î–ê–ù–ù–´–•...")
    
    with engine.connect() as conn:
        # –í–∫–ª—é—á–∞–µ–º –∞–≤—Ç–æ–∫–æ–º–º–∏—Ç –¥–ª—è DDL –æ–ø–µ—Ä–∞—Ü–∏–π
        conn = conn.execution_options(isolation_level="AUTOCOMMIT")
        
        # --- 1. –û–ë–ù–û–í–õ–ï–ù–ò–ï –¢–ê–ë–õ–ò–¶–´ USERS (Soft Migration) ---
        print("üë§ –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ –æ–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É 'users'...")
        try:
            # –î–æ–±–∞–≤–ª—è–µ–º verification_code, –µ—Å–ª–∏ –Ω–µ—Ç
            conn.execute(text("ALTER TABLE users ADD COLUMN IF NOT EXISTS verification_code VARCHAR(6);"))
            # –î–æ–±–∞–≤–ª—è–µ–º is_verified, –µ—Å–ª–∏ –Ω–µ—Ç
            conn.execute(text("ALTER TABLE users ADD COLUMN IF NOT EXISTS is_verified BOOLEAN DEFAULT FALSE;"))
            print("   -> –¢–∞–±–ª–∏—Ü–∞ 'users' –æ–±–Ω–æ–≤–ª–µ–Ω–∞ (–¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã).")
        except Exception as e:
            print(f"   ‚ö†Ô∏è  –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ users (–≤–æ–∑–º–æ–∂–Ω–æ, —É–∂–µ –∞–∫—Ç—É–∞–ª—å–Ω–æ): {e}")

        # --- 2. –ü–ï–†–ï–°–û–ó–î–ê–ù–ò–ï –¢–ê–ë–õ–ò–¶ –¢–ê–†–ò–§–û–í (Hard Reset) ---
        # –ú—ã —É–¥–∞–ª—è–µ–º plans –∏ subscriptions, —á—Ç–æ–±—ã –Ω–∞–∫–∞—Ç–∏—Ç—å –Ω–æ–≤—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É –¥–ª—è –∞–¥–º–∏–Ω–∫–∏
        print("üìâ –ü–µ—Ä–µ—Å–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—ã —Ç–∞—Ä–∏—Ñ–æ–≤ –∏ –ø–æ–¥–ø–∏—Å–æ–∫...")
        try:
            # CASCADE –Ω—É–∂–µ–Ω, —á—Ç–æ–±—ã —É–¥–∞–ª–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ–¥–ø–∏—Å–∫–∏, —Å—Å—ã–ª–∞—é—â–∏–µ—Å—è –Ω–∞ –ø–ª–∞–Ω—ã)
            conn.execute(text("DROP TABLE IF EXISTS subscriptions CASCADE;"))
            conn.execute(text("DROP TABLE IF EXISTS invites CASCADE;"))
            conn.execute(text("DROP TABLE IF EXISTS plans CASCADE;"))
            print("   -> –°—Ç–∞—Ä—ã–µ —Ç–∞–±–ª–∏—Ü—ã (plans, subscriptions, invites) —É–¥–∞–ª–µ–Ω—ã.")
        except Exception as e:
            print(f"   ‚ö†Ô∏è  –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ç–∞–±–ª–∏—Ü: {e}")

    # --- 3. –°–û–ó–î–ê–ù–ò–ï –ù–û–í–´–• –¢–ê–ë–õ–ò–¶ ---
    print("üèóÔ∏è  –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—ã —Å –Ω–æ–≤–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π SQLAlchemy...")
    try:
        # –≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ —Å–æ–∑–¥–∞—Å—Ç plans, subscriptions, invites –∏ –ª—é–±—ã–µ –¥—Ä—É–≥–∏–µ –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ
        Base.metadata.create_all(bind=engine)
        print("‚úÖ  –í—Å–µ —Ç–∞–±–ª–∏—Ü—ã —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω—ã/–ø—Ä–æ–≤–µ—Ä–µ–Ω—ã.")
    except Exception as e:
        print(f"‚ùå  –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü: {e}")
        return

    # --- 4. –ó–ê–õ–ò–í–ö–ê –ë–ê–ó–û–í–´–• –¢–ê–†–ò–§–û–í (–û–ü–¶–ò–û–ù–ê–õ–¨–ù–û) ---
    # –ß—Ç–æ–±—ã –∞–¥–º–∏–Ω–∫–∞ –Ω–µ –±—ã–ª–∞ –ø—É—Å—Ç–æ–π, –º–æ–∂–Ω–æ —Å—Ä–∞–∑—É –≤—ã–∑–≤–∞—Ç—å —Å–∏–¥–µ—Ä, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å.
    # –ù–æ –ø–æ–∫–∞ –ø—Ä–æ—Å—Ç–æ –Ω–∞–ø–æ–º–Ω–∏–º –æ–± —ç—Ç–æ–º.
    print("\nüöÄ –ú–ò–ì–†–ê–¶–ò–Ø –ó–ê–í–ï–†–®–ï–ù–ê!")
    print("1. –¢–∞–±–ª–∏—Ü–∞ —é–∑–µ—Ä–æ–≤ –æ–±–Ω–æ–≤–ª–µ–Ω–∞ (–∞–¥–º–∏–Ω –Ω–∞ –º–µ—Å—Ç–µ).")
    print("2. –¢–∞—Ä–∏—Ñ—ã —Å–±—Ä–æ—à–µ–Ω—ã. –ó–∞–ø—É—Å—Ç–∏ 'init_db.py' –∏–ª–∏ 'seed_plans.py', —á—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Ç–∞—Ä–∏—Ñ—ã.")
    print("3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä: docker-compose restart spreadflow_app")

if __name__ == "__main__":
    fix_database_schema()